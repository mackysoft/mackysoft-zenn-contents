---
title: "Unityã®æœ€å¼·ã‚·ãƒ¼ãƒ³é·ç§»ç®¡ç†ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€Navigathenaã€ã¨ç”»é¢ç®¡ç†ã®è¨­è¨ˆæ€æƒ³ã«ã¤ã„ã¦è§£èª¬"
emoji: "ğŸ“š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["unity", "è¨­è¨ˆ", "ã‚·ãƒ¼ãƒ³ç®¡ç†", "ã‚²ãƒ¼ãƒ é–‹ç™º"]
published: true
published_at: 2023-11-02 12:00
---

## ã¯ã˜ã‚ã«

Unityã«ãŠã„ã¦ã€ã‚·ãƒ¼ãƒ³ã®é·ç§»ãƒ»ç®¡ç†ã¯é–‹ç™ºã®ä¸­æ ¸çš„ãªå½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚ãã‚Œæ•…ã«ã€é©åˆ‡ãªè¨­è¨ˆãªã—ã§é–‹ç™ºã«è¸ã¿è¾¼ã‚€ã¨ã€è¤‡é›‘ã§æ‰±ã„ã¥ã‚‰ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãªã‚‹ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã‚Šã¾ã™ã€‚ã—ã‹ã—ã€åŠ¹æœçš„ãªã‚·ãƒ¼ãƒ³ç®¡ç†ã®è¨­è¨ˆã¨å®Ÿè£…ã‚’ã™ã‚‹ã«ã¯ã€ãã‚Œãªã‚Šã«æ™‚é–“ã¨çŸ¥è­˜ã‚’è¦ã—ã¾ã™ã€‚

ã“ã®èª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€ã€Œé«˜æ©Ÿèƒ½ã€ã€Œæ‹¡å¼µæ€§ã€ã€Œå …ç‰¢æ€§ã€ã‚’å¿µé ­ã«è¨­è¨ˆãƒ»å®Ÿè£…ã—ãŸç”»é¢ç®¡ç†ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã® **ã€Navigathenaã€** ã‚’ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦å…¬é–‹ã—ã¾ã—ãŸã€‚

[[GitHub - mackysoft/Navigathena]](https://github.com/mackysoft/Navigathena)

æœ¬è¨˜äº‹ã§ã¯ã€Navigathenaã®ç‰¹å¾´ã‚„ä½¿ã„æ–¹ã‚’ç´¹ä»‹ã—ã¤ã¤ã€Unityã«ãŠã‘ã‚‹ã‚·ãƒ¼ãƒ³ç®¡ç†ã®è¨­è¨ˆã«ã¤ã„ã¦æ·±æ˜ã£ã¦ã„ãã¾ã™ã€‚

## ã‚·ãƒ¼ãƒ³ç®¡ç†ã«ã¯ä½•ãŒå¿…è¦ã‹ï¼Ÿ

å®Ÿéš›ã«ã€Unityã§ã®é–‹ç™ºã‚’è¡Œã†éš›ã€ã©ã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚„è€ƒæ…®ç‚¹ãŒå¿…è¦ã¨ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ
ã“ã‚Œã¾ã§ã®çµŒé¨“ã‚„é–‹ç™ºäº‹ä¾‹ã‚’è¸ã¾ãˆã‚‹ã¨ã€å¤§ã¾ã‹ã«ä»¥ä¸‹ã®ã‚ˆã†ãªæ©Ÿèƒ½ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

- åŸºæœ¬çš„ãªé·ç§»æ“ä½œ
- é·ç§»å±¥æ­´ç®¡ç†
- ã‚·ãƒ¼ãƒ³é–“ãƒ‡ãƒ¼ã‚¿å—ã‘æ¸¡ã—
- æŸ”è»Ÿãªã‚·ãƒ¼ãƒ³é·ç§»æ¼”å‡º
- å˜ä¸€ã‚·ãƒ¼ãƒ³èµ·å‹•
- å‰²ã‚Šè¾¼ã¿ã‚·ãƒ¼ãƒ³æ“ä½œ

ä»Šå›é–‹ç™ºã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã¯ã€ã“ã‚Œã‚‰ã®è¦ç´ ã‚’ã†ã¾ãçµ„ã¿åˆã‚ã›ã¦ã€åŠ¹æœçš„ãªã‚·ãƒ¼ãƒ³ç®¡ç†ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

ãã—ã¦ä½•ã‚ˆã‚Šã€**ã€Œã‚·ãƒ¼ãƒ³é·ç§»å‘¨ã‚Šã®è¨­è¨ˆãŒè¤‡é›‘åŒ–ã—ã‚„ã™ã„å•é¡Œã®è§£æ±ºã€** ãŒå¿…è¦ã§ã™ã€‚å‰è¿°ã®é€šã‚Šã€ã‚·ãƒ¼ãƒ³ç®¡ç†ã¯é–‹ç™ºã®ä¸­æ ¸ã‚’æ‹…ã†ã‚‚ã®ã§ã‚ã‚Šã€é©åˆ‡ãªè¨­è¨ˆãŒãªã•ã‚Œãªã„ã¨ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ãŒæãªã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒé«˜ã¾ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€ã€Œã‚·ãƒ¼ãƒ³é·ç§»æ™‚ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒè¤‡æ•°ç®‡æ‰€ã«æ•£ã‚‰ã°ã£ã¦ã„ã‚‹ã€ã€Œã‚·ãƒ¼ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã®ç®¡ç†è€…ãŒæ˜ç¢ºã§ãªã„ã€ãªã©ã®å•é¡ŒãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

ã“ã‚Œã«å¯¾ã—ã¦ã¯ã€å…¨ä½“ã‚’é€šã—ã¦ãã†ã„ã£ãŸè¨­è¨ˆä¸Šã®å•é¡Œã‚’é˜²æ­¢ã—ã‚„ã™ã„ä½œã‚Šã«ãªã£ã¦ã„ã¾ã™ã€‚ç†å¿µçš„ãªã‚‚ã®ã‚‚å«ã¾ã‚Œã‚‹ãŸã‚ã€è¨­è¨ˆã«é–¢ã—ã¦ã¯è¨˜äº‹ã®å¾ŒåŠéƒ¨åˆ†ã§æ·±æ˜ã£ã¦ã„ãã¾ã™ã€‚

## Navigathenaã®åŸºæœ¬æ¦‚å¿µ

Navigathenaã«ã¯ã€ã‚·ãƒ¼ãƒ³é·ç§»ã®ãŸã‚ã®2ã¤ã®åŸºæœ¬æ¦‚å¿µã€ **ã€ŒSceneNavigatorã€** ã¨  **ã€ŒSceneEntryPointã€** ãŒã‚ã‚Šã¾ã™ã€‚

### `SceneNavigator`

Navigathenaã§ã¯ã€ã‚·ãƒ¼ãƒ³ã®é·ç§»ã¨ç®¡ç†ã‚’æ‹…å½“ã™ã‚‹`ISceneNavigator`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ã€å¤šãã®ã”å®¶åº­ã§è¦ªã—ã¾ã‚Œã¦ã„ã‚‹SceneManagerã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚’æŒã£ã¦ãŠã‚Šã€ã‚·ãƒ¼ãƒ³ã®å±¥æ­´ã‚’å–ã‚Šæ‰±ã„ã¤ã¤åŸºæœ¬çš„ãªé·ç§»æ“ä½œã‚’æä¾›ã—ã¾ã™ã€‚

ä»¥ä¸‹ã¯`ISceneNavigator`ã®ä½¿ç”¨ä¾‹ã§ã™ã€‚

```cs
ISceneIdentifier identifier = new BuiltInSceneIdentifier("Game");

// ã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€å±¥æ­´ã«è¿½åŠ ã™ã‚‹
await GlobalSceneNavigator.Instance.Push(identifier);

// å±¥æ­´ã®å…ˆé ­ã®ã‚·ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¦ã€ä¸€ã¤å‰ã®ã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
await GlobalSceneNavigator.Instance.Pop();
```

ã‚·ãƒ¼ãƒ³ã®æŒ‡å®šã«ã¯`ISceneIdentifier`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`BuiltInSceneIdentifier`ãŒå®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã€Unityã®Build Settingsã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

:::message
Addressablesã‚’åˆ©ç”¨ã™ã‚‹ä¾‹ã«ã¤ã„ã¦ã¯ã€å¾Œè¿°ã®[ã€Addressables Systemã¨ã®çµ±åˆã€](#addressables-systemã¨ã®çµ±åˆ)ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è§£èª¬ã‚’è¡Œã„ã¾ã™ã€‚
:::

`ISceneNavigator`ã®ä¸»è¦ãªé·ç§»æ“ä½œé–¢æ•°ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```cs
interface ISceneNavigator
{
  // æ–°ãŸãªã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€å±¥æ­´ã«è¿½åŠ ã—ã¾ã™
  UniTask Push (ISceneIdentifier identifier, ITransitionDirector transitionDirector = null, ISceneData sceneData = null, IAsyncOperation interruptOperation = null, CancellationToken cancellationToken = default);

  // å±¥æ­´ã®å…ˆé ­ã®ã‚·ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¦ã€ä¸€ã¤å‰ã®ã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™
  UniTask Pop (ITransitionDirector overrideTransitionDirector = null, IAsyncOperation interruptOperation = null, CancellationToken cancellationToken = default);

  // æ–°ãŸãªã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€å±¥æ­´ã‚’ãã®ã‚·ãƒ¼ãƒ³ã®ã¿ã«ä¸Šæ›¸ãã—ã¾ã™
  UniTask Change (ISceneIdentifier identifier, ITransitionDirector transitionDirector = null, ISceneData sceneData = null, IAsyncOperation interruptOperation = null, CancellationToken cancellationToken = default);

  // æ–°ãŸãªã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€å±¥æ­´ã®å…ˆé ­ã‚’ä¸Šæ›¸ãã—ã¾ã™
  UniTask Replace (ISceneIdentifier identifier, ITransitionDirector transitionDirector = null, ISceneData sceneData = null, IAsyncOperation interruptOperation = null, CancellationToken cancellationToken = default);

  // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™
  UniTask Reload (ITransitionDirector overrideTransitionDirector = null, IAsyncOperation interruptOperation = null, CancellationToken cancellationToken = default);
}
```

:::message
ä¸Šè¨˜ã®é–¢æ•°ç¾¤ã¯æ­£ç¢ºã«è¨€ã†ã¨ã€`ISceneNavigator`ã®æ‹¡å¼µé–¢æ•°ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚
:::

é·ç§»ãƒ­ã‚¸ãƒƒã‚¯ã¯`ISceneNavigator`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§æŠ½è±¡åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ç‰¹å®šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ç‰¹åˆ¥ãªå‡¦ç†ãŒå¿…è¦ãªå ´åˆã€ã‚«ã‚¹ã‚¿ãƒ SceneNavigatorã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ï¼ˆæŒ‡å®šãŒç„¡ã„å ´åˆã¯ã€`StandardSceneNavigator`ãŒä½¿ç”¨ã•ã‚Œã¾ã™ï¼‰

```cs:NavigathenaInitializer.cs
[RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.BeforeSceneLoad)]
static void Initialize ()
{
  // ã‚«ã‚¹ã‚¿ãƒ SceneNavigatorã‚’ç™»éŒ²ã™ã‚‹
  GlobalSceneNavigator.Instance.Register(new MyCustomSceneNavigator());
}
```

ã‚²ãƒ¼ãƒ ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’é€šã˜ã¦ã€ã‚·ãƒ¼ãƒ³ç®¡ç†ã¯åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã»ã¨ã‚“ã©ã§ã‚ã‚‹ãŸã‚ã€ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã‚ã‚‹`GlobalSceneNavigator`ã‚’å®Ÿè£…ã—ã¦ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ç™»éŒ²ã•ã‚ŒãŸ`ISceneNavigator`ã‚’ãƒ©ãƒƒãƒ—ã—ã€å¾Œè¿°ã®ã€Œå˜ä¸€ã‚·ãƒ¼ãƒ³èµ·å‹•ã€ãªã©ã®æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã‚’ã—ã¦ã„ã¾ã™ã€‚

ã¡ãªã¿ã«`GlobalSceneNavigator`ã®ã‚¤ãƒ³ã‚¹ãƒšã‚¯ã‚¿ãƒ¼ã§ã¯ã€ç™»éŒ²ã•ã‚ŒãŸ`ISceneNavigator`ã¨ã€ç¾åœ¨ã®å±¥æ­´ã‚’ç¢ºèªã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/af995c2c903c-20231023.png)

### `SceneEntryPoint`

æ¬¡ã«ã€ã‚·ãƒ¼ãƒ³ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’ç›£è¦–ã™ã‚‹ãŸã‚ã®`SceneEntryPoint`ã¨ã„ã†æ¦‚å¿µãŒå°å…¥ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯å„ã‚·ãƒ¼ãƒ³ã«ä¸€ã¤ã ã‘é…ç½®å¯èƒ½ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã€ã‚·ãƒ¼ãƒ³ã®é–‹å§‹ã€çµ‚äº†ã€ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ç­‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ã™ã‚‹å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚`SceneEntryPoint`ãŒã‚·ãƒ¼ãƒ³ã«å˜ä¸€ã§å­˜åœ¨ã—ã¤ã¤ã€ã‚·ãƒ¼ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ±æ‹¬ã™ã‚‹ã“ã¨ã§ã€ã‚·ãƒ¼ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã®è¤‡é›‘åŒ–ã‚’é˜²æ­¢ã™ã‚‹ã“ã¨ã«ç¹‹ãŒã‚Šã¾ã™ã€‚

åŸºæœ¬çš„ã«ã€`SceneEntryPoint`ã¯ã€`SceneEntryPointBase`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç¶™æ‰¿ã—ã¦ã€å„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚

```cs:TitleSceneEntryPoint.cs
using System.Threading;
using Cysharp.Threading.Tasks;
using MackySoft.Navigathena.SceneManagement;

// ã‚¿ã‚¤ãƒˆãƒ«ã‚·ãƒ¼ãƒ³ã®SceneEntryPointã‚’å®Ÿè£…ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
public sealed class TitleSceneEntryPoint : SceneEntryPointBase
{
  protected override async UniTask OnEnter (ISceneDataReader reader, CancellationToken cancellationToken)
  {
    await DoSomething(cancellationToken);
  }
}
```

:::message
`MonoBehaviour`ã®ç¶™æ‰¿ã«ä¾å­˜ã—ãªã„å®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦ã¯ã€[ã€Œä¾å­˜æ€§æ³¨å…¥ã¨ã®çµ±åˆã€](#ä¾å­˜æ€§æ³¨å…¥ã¨ã®çµ±åˆ)ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
:::

SceneEntryPointã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®šç¾©ã—ãŸã‚‰ã€ã‚·ãƒ¼ãƒ³ã«1ã¤é…ç½®ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/6e9ebbecfc2f-20231031.png)

ã‚ã¨ã¯ã“ã®ã‚·ãƒ¼ãƒ³ã‚’å®Ÿè¡Œã™ã‚Œã°ã€`TitleSceneEntryPoint`ã®èµ·å‹•æ™‚ã‚¤ãƒ™ãƒ³ãƒˆãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

ä»¥ä¸‹ã¯`SceneEntryPoint`ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸€è¦§ã§ã™ã€‚

```cs:ISceneEntryPoint.cs
public interface ISceneEntryPoint
{
  // é·ç§»æ¼”å‡ºã®é–‹å§‹å¾Œã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
  UniTask OnInitialize (ISceneDataReader reader, IProgress<IProgressDataStore> transitionProgress, CancellationToken cancellationToken);

  // é·ç§»æ¼”å‡ºã®çµ‚äº†å¾Œã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
  UniTask OnEnter (ISceneDataReader reader, CancellationToken cancellationToken);

  // é·ç§»æ¼”å‡ºã®é–‹å§‹å‰ã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
  UniTask OnExit (ISceneDataWriter writer, CancellationToken cancellationToken);

  // é·ç§»æ¼”å‡ºã®é–‹å§‹å¾Œã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
  UniTask OnFinalize (ISceneDataWriter writer, IProgress<IProgressDataStore> transitionProgress, CancellationToken cancellationToken);

#if UNITY_EDITOR
  // ã‚¨ãƒ‡ã‚£ã‚¿å†…ã§ã®å®Ÿè¡Œæ™‚ã€ä¸€ç•ªæœ€åˆã«ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ãƒ³ã§`OnInitialize`ã®å‰ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚ (ã‚¨ãƒ‡ã‚£ã‚¿å°‚ç”¨)
  UniTask OnEditorFirstPreInitialize (ISceneDataWriter writer, CancellationToken cancellationToken);
#endif
}
```

é·ç§»æ“ä½œãŒå‘¼ã°ã‚ŒãŸã¨ãã®ã‚·ãƒ¼ãƒ³é·ç§»ã®æµã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

1. é·ç§»å…ƒ`ISceneEntryPoint`ã®`OnExit`
2. é·ç§»æ“ä½œæ™‚ã«æ¸¡ã•ã‚ŒãŸ`ITransitionDirector`ã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸ`ITransitionHandle`ã®`Start`
3. é·ç§»å…ƒ`ISceneEntryPoint`ã®`OnFinalize`
4. é·ç§»å…ƒã‚·ãƒ¼ãƒ³ã®ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰
5. é·ç§»æ“ä½œæ™‚ã«æ¸¡ã•ã‚ŒãŸ`IAsyncOperation`ã®`ExecuteAsync`
6. é·ç§»å…ˆã‚·ãƒ¼ãƒ³ã®ãƒ­ãƒ¼ãƒ‰
7. é·ç§»å…ˆ`ISceneEntryPoint`ã®`OnInitialize`
8. 2ã§ä½¿ç”¨ã•ã‚ŒãŸ`ITransitionHandle`ã®`End`
9. é·ç§»å…ˆ`ISceneEntryPoint`ã®`OnEnter`

å„ã‚¤ãƒ™ãƒ³ãƒˆãŒæœãŸã™å½¹å‰²ã«ã¤ã„ã¦ã¯ã€å¾Œè¿°ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

### æ¦‚è¦å›³

Navigathenaã®ã‚·ãƒ¼ãƒ³ç®¡ç†ã®ä¸»è¦ãªè¦ç´ ã¯ä»¥ä¸‹ã®å›³ã®ã‚ˆã†ã«ã¾ã¨ã¾ã£ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/c8257eec1c55-20231023.png)

å¤šãã®å ´åˆã€`SceneEntryPointBase`ã‚’ç¶™æ‰¿ã—ã¦å„ã‚·ãƒ¼ãƒ³ã®æŒ™å‹•ã‚’å®Ÿè£…ã—ã€`GlobalSceneNavigator`ã‚’ä»‹ã—ã¦é·ç§»æ“ä½œã‚’è¡Œã†ã ã‘ã§ååˆ†ã§ã™ã€‚å¿…è¦ã«å¿œã˜ã¦`ISceneNavigator`ã‚’æ‹¡å¼µã—ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã€`GlobalSceneNavigator`ã«ç™»éŒ²ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é©ç”¨ã—ã¾ã—ã‚‡ã†ã€‚

## ã‚·ãƒ¼ãƒ³é·ç§»æ¼”å‡º

ã‚²ãƒ¼ãƒ ã®ä½“é¨“ã‚’å½©ã‚‹è¦ç´ ã®ä¸€ã¤ã¨ã—ã¦ã€ã‚·ãƒ¼ãƒ³é·ç§»æ¼”å‡ºãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã¯ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ»ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã§ã‚ã£ãŸã‚Šã€Tipsã®è¡¨ç¤ºã€ãƒŸãƒ‹ã‚­ãƒ£ãƒ©ãŒç”»é¢ã‚’é§†ã‘æŠœã‘ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¾ã§å¤šå²ã«ã‚ãŸã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã©ã®æ§˜ã«å®Ÿè£…ã‚’è¡Œã†ã‹ã«ã—ã¦ã‚‚ã€Canvasè¦ç´ ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã•ã›ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã—ã€è¿½åŠ ã§é·ç§»æ¼”å‡ºã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ã€‚ã„ãšã‚Œã«ã›ã‚ˆã€ã‚·ã‚¹ãƒ†ãƒ ãŒæŸ”è»Ÿã§ã‚ã‚‹ã“ã¨ã€ã™ãªã‚ã¡ç•°ãªã‚‹ã‚¿ã‚¤ãƒ—ã®æ¼”å‡ºã‚’ç°¡å˜ã«è¿½åŠ ãƒ»å¤‰æ›´ã§ãã‚‹ã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚

Navigathenaã§ã®ã‚·ãƒ¼ãƒ³é·ç§»æ™‚ã®æ¼”å‡ºã¯`ITransitionDirector`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ã‚·ãƒ¼ãƒ³é·ç§»æ“ä½œæ™‚ã®å¼•æ•°ã«ã¯`ITransitionDirector`ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```cs
public interface ITransitionDirector
{
  ITransitionHandle CreateHandle ();
}

public interface ITransitionHandle
{
  UniTask Start (CancellationToken cancellationToken = default);
  UniTask End (CancellationToken cancellationToken = default);
}
```

`ITransitionDirector`ã¯`ITransitionHandle`ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ãƒ•ã‚¡ã‚¯ãƒˆãƒªã«ãªã£ã¦ãŠã‚Šã€`ITransitionHandle`ã¯é·ç§»æ¼”å‡ºã®é–‹å§‹ã¨çµ‚äº†ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™ã€‚

ã“ã®`ITransitionDirector`ãŠã‚ˆã³`ITransitionHandle`ã‚’åŸºã«æ‹¡å¼µã‚’è¡Œã†ã“ã¨ã§ã€ç‹¬è‡ªã®é·ç§»æ¼”å‡ºã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ã‚§ãƒ¼ãƒ‰ã«ã‚ˆã‚‹é·ç§»æ¼”å‡ºã‚’å®Ÿç¾ã™ã‚‹`SimpleTransitionDirector`ã®å®Ÿè£…ä¾‹ã§ã™ã€‚

```cs:SimpleTransitionDirector.cs
public sealed class SimpleTransitionDirector : ITransitionDirector
{

  readonly CanvasGroup m_CanvasGroup;

  public SimpleTransitionDirector (CanvasGroup canvasGroup)
  {
    m_CanvasGroup = canvasGroup;
  }

  public ITransitionHandle Create ()
  {
    return new SimpleTransitionHandle(m_CanvasGroup);
  }

  sealed class SimpleTransitionHandle : ITransitionHandle
  {

    readonly CanvasGroup m_CanvasGroup;

    public SimpleTransitionHandle (CanvasGroup canvasGroup)
    {
      m_CanvasGroup = canvasGroup;
    }

    public async UniTask Start (CancellationToken cancellationToken = default)
    {
      // DOTweenã§ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚’å®Ÿè¡Œ
      await m_CanvasGroup.DOFade(1f, 1f).ToUniTask(cancellationToken: cancellationToken);
    }

    public async UniTask End (CancellationToken cancellationToken = default)
    {
      await m_CanvasGroup.DOFade(0f, 1f).ToUniTask(cancellationToken: cancellationToken);
    }
  }
}
```

```cs
// SimpleTransitionDirectorã§æ¼”å‡ºã‚’å®Ÿè¡Œã—ã¤ã¤ã€æ–°ãŸãªã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
await GlobalSceneNavigator.Instance.Push(new BuiltInSceneIdentifier("MyScene"), new SimpleTransitionDirector(m_CanvasGroup));
```

### é·ç§»ä¸­ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º

é·ç§»æ¼”å‡ºã§ã¯ã€é€²æ—ç‡ã®è¡¨ç¤ºã‚„ã€é€²æ—ç‡ã«ã‚ˆã£ã¦å¤‰å‹•ã™ã‚‹æ¼”å‡ºãŒå¿…è¦ã«ãªã‚‹ã“ã¨ã‚‚å°‘ãªããªã„ã§ã—ã‚‡ã†ã€‚

Navigathenaã§ã¯ã€é·ç§»æ¼”å‡ºä¸­ã«ã¯`IProgress<IProgressDataStore>`ã‚’ã‚’ä»‹ã—ã€ä»»æ„ã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’æ¸¡ã™ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚é·ç§»æ¼”å‡ºä¸­ã«æŒŸã¾ã‚Œã‚‹å‡¦ç†ï¼ˆ`ISceneEntryPoint.OnInitialize`/`OnFinalize`ã€`IAsyncOperation.ExecuteAsync`ï¼‰ã«ã¯ã€`IProgress<IProgressDataStore>`ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚å„ã‚¤ãƒ™ãƒ³ãƒˆå†…ã§`IProgressDataStore`ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿ã€`IProgress<IProgressDataStore>`ã«é€šçŸ¥ã™ã‚‹ã“ã¨ã§ã€é·ç§»ã®é€²æ—çŠ¶æ³ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã©ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æç¤ºã—ãŸã„æƒ…å ±ã‚’é·ç§»æ¼”å‡ºã«çµ„ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€å…ˆã»ã©ã®`SimpleTransitionDirector`ã‚’æ‹¡å¼µã—ã€é€²æ—è¡¨ç¤ºã«å¯¾å¿œã•ã›ã‚‹ä¾‹ã§ã™ã€‚

```cs:MyProgressData.cs
// ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æƒ…å ±ã¨ã—ã¦ä½¿ç”¨ã—ãŸã„ä»»æ„ã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’å®šç¾©ã™ã‚‹
public readonly struct MyProgressData
{
  
  public float Progress { get; }
  public string Message { get; }

  public MyProgressData (float progress, string message)
  {
    Progress = progress;
    Message = message;
  }
}
```

```cs:SimpleTransitionDirector.cs
public sealed class SimpleTransitionDirector : ITransitionDirector
{

  readonly CanvasGroup m_CanvasGroup;
  readonly Text m_ProgressText;
  readonly Text m_MessageText;
  readonly Slider m_ProgressSlider;

  public SimpleTransitionDirector (CanvasGroup canvasGroup, Text progressText, Text messageText, Slider progressSlider)
  {
    m_CanvasGroup = canvasGroup;
    m_ProgressText = progressText;
    m_MessageText = messageText;
    m_ProgressSlider = progressSlider;
  }

  public ITransitionHandle Create ()
  {
    return new SimpleTransitionHandle(m_CanvasGroup, m_ProgressText, m_MessageText, m_ProgressSlider);
  }

  // IProgress<IProgressDataStore>ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€é·ç§»æ¼”å‡ºä¸­ã«ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æƒ…å ±ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã‚‹
  sealed class SimpleTransitionHandle : ITransitionHandle, IProgress<IProgressDataStore>
  {

    readonly CanvasGroup m_CanvasGroup;
    readonly Text m_ProgressText;
    readonly Text m_MessageText;
    readonly Slider m_ProgressSlider;

    public SimpleTransitionHandle (CanvasGroup canvasGroup, Text progressText, Text messageText, SLider progressSlider)
    {
      m_CanvasGroup = canvasGroup;
      m_ProgressText = progressText;
      m_MessageText = messageText;
      m_ProgressSlider = progressSlider;
    }

    public async UniTask Start (CancellationToken cancellationToken = default)
    {
      await m_CanvasGroup.DOFade(1f,1f).ToUniTask(cancellationToken: cancellationToken);
    }

    public async UniTask Complete (CancellationToken cancellationToken = default)
    {
      await m_CanvasGroup.DOFade(0f,1f).ToUniTask(cancellationToken: cancellationToken);
    }

    void IProgress<IProgressDataStore>.Report (IProgressDataStore progressDataStore)
    {
      // IProgressStoreã‹ã‚‰MyProgressDataã‚’å–ã‚Šå‡ºã™
      if (progressDataStore.TryGetData(out MyProgressData myProgressData))
      {
        m_ProgressText.text = myProgressData.Progress.ToString("P0");
        m_MessageText.text = myProgressData.Message;
        m_ProgressSlider.value = myProgressData.Progress;
      }
    }
  }
}
```

```cs
// é·ç§»æ“ä½œæ™‚ã«SimpleTransitionDirectorã‚’æ¸¡ã™
await GlobalSceneNavigator.Instance.Push(new BuiltInSceneIdentifier("MyScene"), new SimpleTransitionDirector(m_CanvasGroup, m_ProgressText, m_MessageText, m_ProgressSlider));
```

```cs:MySceneEntryPoint.cs
// ...

// progressã«é€šçŸ¥ã‚’è¡Œã†ã¨ã€SimpleTransitionDirectorã¾ã§é€šçŸ¥ã•ã‚Œã‚‹
protected override UniTask OnInitialize (ISceneDataReader reader, IProgress<IProgressDataStore> progress, CancellationToken cancellationToken)
{
  ProgressDataStore<MyProgressData> store = new();

  progress.Report(store.SetData(new MyProgressData(0.5f, "Generate Map")));

  await m_MapGenerator.Generate(cancellationToken);

  progress.Report(store.SetData(new MyProgressData(1f, "Complete")));
}
```

æ±ç”¨æ€§ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã€`IProgressDataStore.TryGetData<T>`ã‚’ä»‹ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ï¼ˆå†…éƒ¨çš„ã«ã¯`IProgressDataStore`ã‚’`IProgressDataStore<T>`ã«ã‚­ãƒ£ã‚¹ãƒˆã—ã¦å‹ã‚’å–ã‚Šå‡ºã—ã¦ã„ã¾ã™ï¼‰
å‹å®‰å…¨ã§ã¯ãªã„ã®ã§ã™ãŒã€ãƒœãƒƒã‚¯ã‚¹åŒ–ã«ã‚ˆã‚‹ç„¡é§„ãªå‰²ã‚Šå½“ã¦ã®é˜²æ­¢ã¨ã€ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã®ä¼æ¬ã«ã‚ˆã£ã¦ç°¡æ˜“æ€§ãŒå¤±ã‚ã‚Œã‚‹ã®ã‚’é¿ã‘ã‚‹ãŸã‚ã«ã“ã®ã‚ˆã†ãªå®Ÿè£…ãŒå¦¥å½“ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚

ã‚·ãƒ¼ãƒ³ãŒãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹æ™‚ã€`StandardSceneNavigator`ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`IProgressDataStore`ã«`LoadSceneProgressData`ã‚’æ ¼ç´ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã“ã®æŒ™å‹•ã¯`StandardSceneNavigator`ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‹ã‚‰ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

```cs:NavigathenaInitializer.cs
[RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.BeforeSceneLoad)]
static void Initialize ()
{
  // è‡ªå‰ã®MySceneProgressFactoryã§StandardSceneNavigatorã‚’åˆæœŸåŒ–ã—ã¦ç™»éŒ²ã™ã‚‹
  GlobalSceneNavigator.Instance.Register(new StandardSceneNavigator(TransitionDirector.Empty(), new MySceneProgressFactory()));
}
```

### ã‚·ãƒ¼ãƒ³é·ç§»ä¸­å‡¦ç†ã®çµ„è¾¼ã¿

ã‚·ãƒ¼ãƒ³é·ç§»æ™‚ã«ã¯äº‹å‰ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚„ã€ä½•ã‹ã—ã‚‰ã®äº‹å‰ãƒã‚§ãƒƒã‚¯å‡¦ç†ã‚’æŒŸã¿ã“ã¿ãŸã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

Navigathenaã§ã¯ã€Œç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã®ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒçµ‚ã‚ã£ã¦ã‹ã‚‰ã€æ¬¡ã®ã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¾ã§ã®é–“ã«æŒŸã¿ãŸã„å‡¦ç†ã€ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã€`IAsyncOperation`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚`IAsyncOperation`ã¯`ISceneNavigator`ã«ãŠã‘ã‚‹å„é·ç§»æ“ä½œæ™‚ã«æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```cs
IAsyncOperation op = m_PreloadAsyncOperation;
await GlobalSceneNavigator.Push(nextScene, interruptOperation: op);
```

`IAsyncOperation`ã®æ§‹æˆã¯éå¸¸ã«å˜ç´”ã§ã€éåŒæœŸå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚`IProgress<IProgressDataStore>`ãŒå¼•æ•°ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹ãŸã‚ã€é·ç§»æ¼”å‡ºä¸­ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºã¨çµ±åˆã™ã‚‹äº‹ã‚‚å¯èƒ½ã§ã™ã€‚

```cs:IAsyncOperation.cs
public interface IAsyncOperation
{
  UniTask ExecuteAsync (IProgress<IProgressDataStore> progress, CancellationToken cancellationToken = default);
}
```

åŸºæœ¬çš„ã«ã¯`IAsyncOperation`ã‚’å®Ÿè£…ã—ãŸå‹ã‚’å®šç¾©ã™ã‚‹äº‹ã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ãŒã€ä¾¿åˆ©ã«æ‰±ã†ãŸã‚ã®ä¾¿åˆ©é–¢æ•°ã‚‚ã„ãã¤ã‹ç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

```cs
// åŒ¿åã®IAsyncOperationã‚’ä½œæˆã™ã‚‹
IAsyncOperation operation = AsyncOperation.Create(async (progress, cancellationToken) => {
  // ä½•ã‚‰ã‹ã®éåŒæœŸå‡¦ç†
  await DoSomething(progress, cancellationToken);
});

// è¤‡æ•°ã®IAsyncOperationã‚’ãƒãƒ¼ã‚¸
IAsyncOperation compositeOperation = AsyncOperation.Combine(op1, op2, op3);
```

## ã‚·ãƒ¼ãƒ³é–“ã®ãƒ‡ãƒ¼ã‚¿å—ã‘æ¸¡ã—

ã‚²ãƒ¼ãƒ ã‚’ä½œã£ã¦ã„ã‚‹ã¨ã€æ¬¡ã®ã‚·ãƒ¼ãƒ³ã«å€¤ã‚’æ¸¡ã—ãŸã„ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã«é­é‡ã—ã¾ã™ã€‚ã‚ˆãã‚ã‚‹ã®ãŒã€ã€Œé¸æŠã—ãŸè¦ç´ ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãªã©ï¼‰ã®IDã‚’æ¬¡ã®ã‚·ãƒ¼ãƒ³ã«æ¸¡ã—ãŸã„ã€ã¨ã„ã£ãŸã‚±ãƒ¼ã‚¹ã§ã™ã€‚

`ISceneEntryPoint`ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã¯ã€

- `OnInitialize` / `OnEnter` ã« `ISceneDataReader`
- `OnExit` / `OnFinalize` ã« `ISceneDataWriter` 

ãŒæ¸¡ã•ã‚Œã€ã“ã‚Œã‚‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã‚ˆã£ã¦ã‚·ãƒ¼ãƒ³é–“ã®ãƒ‡ãƒ¼ã‚¿ã®ã‚„ã‚Šå–ã‚Šã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¾‹ãˆã°ã€`ISceneNavigator.Push`ã®å¼•æ•°ã«ã€`ISceneData`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ãŸãƒ‡ãƒ¼ã‚¿å‹ã‚’æ¸¡ã™ã“ã¨ã§ã€é·ç§»å…ˆã®`ISceneEntryPoint`ã®`OnInitialize`ã¨`OnEnter`ã«å¯¾ã—ã¦ã€ãã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```cs
// ã‚·ãƒ¼ãƒ³é–“ã§æ¸¡ã—ãŸã„ãƒ‡ãƒ¼ã‚¿ã‚’å®šç¾©ã™ã‚‹
public sealed class IngameSceneData : ISceneData
{
  public int CharacterId { get; init; }
}

// ...

// sceneDataã«ã€æ¸¡ã—ãŸã„ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹
await GlobalSceneNavigator.Instance.Push(new BuiltInSceneIdentifier("Ingame"), sceneData: new IngameSceneData
{
  CharacterId = 1
});
```

```cs:IngameSceneEntryPoint.cs
protected override UniTask OnEnter (ISceneDataReader reader, CancellationToken cancellationToken)
{
  // é·ç§»æ™‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã‚‹
  if (reader.TryRead(out IngameSceneData sceneData))
  {
    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç”Ÿæˆã—ãŸã‚Šã—ã¦ã¿ã‚‹
    Spawn(sceneData.CharacterId);
  }
}
```

ä¸€æ–¹ã€ã‚·ãƒ¼ãƒ³ã‚’é›¢è„±ã™ã‚‹ã¨ãã«æ¸¡ã•ã‚Œã‚‹`ISceneDataWriter`ã§ã™ãŒã€ã“ã¡ã‚‰ã¯ã‚·ãƒ¼ãƒ³é›¢è„±æ™‚ã®çŠ¶æ…‹ã‚’ã‚·ãƒ¼ãƒ³å±¥æ­´ã«ä¿å­˜ã—ã€ãã®ã‚·ãƒ¼ãƒ³ã«æˆ»ã£ã¦ããŸã¨ãã«ã‚·ãƒ¼ãƒ³ã®çŠ¶æ…‹ã‚’å¾©å…ƒã™ã‚‹ã‚ˆã†ãªå‡¦ç†ã®å®Ÿè£…ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€ã€Œã‚·ãƒ¼ãƒ³å†…ã§ç‰¹å®šã®ç”»é¢ã‚’é–‹ã„ãŸçŠ¶æ…‹ã€ã§æ¬¡ã®ã‚·ãƒ¼ãƒ³ã«é·ç§»ã—ã€å‰ã®ã‚·ãƒ¼ãƒ³ã«æˆ»ã‚‹æ™‚ã¯ã€`ISceneDataWriter`ã«æ›¸ãè¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒ`OnInitialize` / `OnEnter`ã«æ¸¡ã•ã‚Œã‚‹ã®ã§ã€ã‚·ãƒ¼ãƒ³åˆæœŸåŒ–æ™‚ã«ã¯ã€Œã©ã®ç”»é¢ã‚’é–‹ã„ã¦ã„ãŸã‹ã€ã®æƒ…å ±ã‚’å–å¾—ã—ã¦ã€ã‚·ãƒ¼ãƒ³ã®çŠ¶æ…‹ã‚’å¾©å…ƒã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```cs:HomeSceneEntryPoint.cs
public sealed class HomeSceneData : ISceneData
{
  public HomeScreenType LastDisplayedScreenType { get; init; }
}

public sealed class HomeSceneEntryPoint : SceneEntryPoint
{

  [SerializeField]
  HomeView m_View;

  protected override UniTask OnInitialize (ISceneDataReader reader, CancellationToken cancellationToken)
  {
    // ã‚·ãƒ¼ãƒ³èµ·å‹•æ™‚ã€ä¿å­˜ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã‚’å–å¾—ã—ã¦ã‚·ãƒ¼ãƒ³ã®è¦ç´ ã«é©ç”¨ã™ã‚‹
    if (reader.TryRead(out HomeSceneData sceneData))
    {
      m_View.SetScreen(sceneData.LastDisplayedScreenType);
    }
  }

  protected override UniTask OnFinalize (ISceneWriter writer, CancellationToken cancellationToken)
  {
    // ã‚·ãƒ¼ãƒ³é›¢è„±æ™‚ã€çŠ¶æ…‹ã‚’ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜ã™ã‚‹
    writer.Write(new HomeSceneData
    {
      LastDisplayedScreenType = m_View.ScreenType
    });
  }
}
```

:::message
å‹å®‰å…¨æ€§ãŒæãªã‚ã‚Œã‚‹ã“ã¨ã‚’é¿ã‘ã‚‹ãŸã‚ã€`ISceneData`å‹ã®å®šç¾©ã¯ã€Œ1ã‚·ãƒ¼ãƒ³ã«ã¤ã1ã¤ã€ã§çµ±ä¸€ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
:::

## å˜ä¸€ã‚·ãƒ¼ãƒ³èµ·å‹•

Unityã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§ã®ãƒ‡ãƒãƒƒã‚°ã§ã¯ã€ã€Œã©ã®ã‚·ãƒ¼ãƒ³ã‹ã‚‰ã§ã‚‚ã‚²ãƒ¼ãƒ ã‚’æ­£å¸¸ã«èµ·å‹•ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€ã“ã¨ã§é–‹ç™ºåŠ¹ç‡ãŒå‘ä¸Šã—ã¾ã™ã€‚

ç‰¹ã«ã‚·ãƒ¼ãƒ³ã®éšå±¤æ§‹é€ ãŒæ·±ã‹ã£ãŸã‚Šã€æ©Ÿèƒ½ã¾ã§ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãŒé•·ã„ã¨åŠ¹æœãŒé¡•è‘—ã«ç¾ã‚Œã¾ã™ã€‚Photonã§ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚²ãƒ¼ãƒ ã‚’ä½œã£ã¦ã„ã‚‹æ™‚ã¯ã€ãƒãƒƒãƒãƒ³ã‚°å‡¦ç†ã‚’é£›ã°ã—ã¦ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã®ãƒ‡ãƒãƒƒã‚°å‡ºæ¥ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€é–‹ç™ºã‚µã‚¤ã‚¯ãƒ«ã‚’çŸ­ç¸®ã—ã¦ã„ã¾ã—ãŸã€‚

`ISceneEntryPoint`ã§ã¯ã€`OnEditorFirstPreInitialize`ã¨ã„ã†ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼å°‚ç”¨ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ç”¨æ„ã—ã¦ãŠã‚Šã€ã€Œã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ä¸Šã§ä¸€ç•ªæœ€åˆã«èµ·å‹•ã•ã‚ŒãŸã‚·ãƒ¼ãƒ³ã€ã§å‘¼ã°ã‚Œã¾ã™ã€‚ã“ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã€ä¸€ç•ªæœ€åˆã«èµ·å‹•ã•ã‚ŒãŸæ™‚ã«ã¯`ISceneDataWriter`ãŒæ¸¡ã•ã‚Œã‚‹ãŸã‚ã€åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚“ã§å¾Œç¶šã® `OnInitialize` / `OnEnter` ã«å¯¾ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```cs:IngameSceneEntryPoint.cs
protected override UniTask OnEnter (ISceneDataReader reader, CancellationToken cancellationToken)
{
  // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§æœ€åˆã«èµ·å‹•ã•ã‚ŒãŸã¨ãã€OnEditorFirstPreInitializeã§æ›¸ãè¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã‚‹
  if (reader.TryRead(out IngameSceneData sceneData))
  {
    Spawn(sceneData.CharacterId);
  }
}

#if UNITY_EDITOR
protected override UniTask OnEditorFirstPreInitialize (ISceneDataWriter writer, CancellationToken cancellationToken)
{
  // ISceneDataWriterã«åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€
  writer.Write(new IngameSceneData
  {
    CharacterId = m_EditorTestCharacterId
  });
  return UniTask.CompletedTask;
}
#endif
```

:::message
`OnEditorFirstPreInitialize`ã¯`UNITY_EDITOR`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§å›²ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
:::

## å‰²ã‚Šè¾¼ã¿ã‚·ãƒ¼ãƒ³æ“ä½œ

æ™‚ã€…ã€ã‚·ãƒ¼ãƒ³é·ç§»ã®å‡¦ç†ä¸­ã«ã€æ§˜ã€…ãªãƒã‚§ãƒƒã‚¯ã‚„é€šä¿¡ã®å¤±æ•—ãªã©ã®äº‹è±¡ãŒç™ºç”Ÿã—ã€åˆ¥ã®ã‚·ãƒ¼ãƒ³ã¸ã®é·ç§»å‡¦ç†ã§ä¸Šæ›¸ãã—ãŸããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€ã€Œã‚¤ãƒ™ãƒ³ãƒˆã‚·ãƒ¼ãƒ³ã¸é·ç§»ä¸­ã«ã€`OnInitialize`ã§ã®ãƒã‚§ãƒƒã‚¯ã§ã‚¤ãƒ™ãƒ³ãƒˆã®æœŸé–“ãŒçµ‚äº†ã—ã¦ã„ãŸãŸã‚ã€`Pop`ã‚’ä½¿ç”¨ã—ã¦å‰ã®ã‚·ãƒ¼ãƒ³ã«æˆ»ã‚ŠãŸã„ã€ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®æ™‚ã€ç¾åœ¨ã®é·ç§»å‡¦ç†ã‚’ä¸­æ–­ã—ã¦ã‚·ãƒ¼ãƒ³é·ç§»æ“ä½œã‚’å‰²ã‚Šè¾¼ã¾ã›ã‚‹ã®ã§ã™ãŒã€ã“ã‚Œã‚’æ­£ã—ãå®Ÿè£…ã—ã‚ˆã†ã¨ã™ã‚‹ã¨å†…éƒ¨ã®çŠ¶æ…‹ç®¡ç†ãŒåœ°å‘³ã«å¤§å¤‰ã§ã™ã€‚

Navigathenaã§ã¯ã€ã“ã®ã‚ˆã†ãªå‰²ã‚Šè¾¼ã¿å‡¦ç†ã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
ä»¥ä¸‹ã¯ã€å®Ÿéš›ã®å‹•ä½œã®ç°¡å˜ãªä¾‹ã§ã™ã€‚

```cs:EventSceneEntryPoint.cs
protected override async UniTask OnInitialize (ISceneDataReader reader, IProgress<IProgressDataStore> progress, CancellationToken cancellationToken)
{
  // ã‚¤ãƒ™ãƒ³ãƒˆã®æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã‚‹ã¨ä»®å®šã™ã‚‹
  bool isExpired = true;

  if (isExpired) {
    // NOTE: cancellationTokenã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«çŠ¶æ…‹ã«ãªã‚‹ãŸã‚ã€é·ç§»æ“ä½œã«ã¯æ¸¡ã•ãªã„
    await GlobalSceneNavigator.Instance.Pop(CancellationToken.None);

    // true
    Debug.Log(cancellationToken.IsCancellationRequested);
  }
}

protected override UniTask OnEnter (ISceneDataReader reader, CancellationToken cancellationToken)
{
  // OnInitializeå†…ã§é·ç§»æ“ä½œãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ãŸã‚‰å®Ÿè¡Œã•ã‚Œãªã„
  Debug.Log("EventSceneEntryPoint.OnEnter");
  return UniTask.CompletedTask;
}
```
æ–°ãŸãªé·ç§»å‡¦ç†ã‚’å‰²ã‚Šè¾¼ã¾ã›ã‚‹ã“ã¨ã§ã€SceneNavigatorãŒç®¡ç†ã™ã‚‹`CancellationTokenSource`ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã€ãã‚Œã«ä¼´ã£ã¦æ¸¡ã•ã‚Œã‚‹`CancellationToken`ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«çŠ¶æ…‹ã¨ãªã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚ä¸Šè¨˜ã®ä¾‹ã§ã¯ã€`Pop`å‘¼ã³å‡ºã—å¾Œã«`cancellationToken`ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«è¦æ±‚çŠ¶æ…‹ã¨ãªã‚Šã€ãã®çµæœã€`OnEnter`ãŒå‘¼ã°ã‚Œãªããªã‚‹ã“ã¨ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

## ã‚·ãƒ¼ãƒ³å±¥æ­´ã®ç›´æ¥æ“ä½œ

æ™‚æŠ˜ã€ç¾åœ¨ã®å±¥æ­´ã‚’ç„¡è¦–ã—ã¦æ–°ã—ã„å±¥æ­´ã‚’æ§‹ç¯‰ã—ãŸã„å ´é¢ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€Œä»»æ„ã®ã‚·ãƒ¼ãƒ³ã«ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹ãŒã€ãã®ã‚·ãƒ¼ãƒ³ã§`Pop`ã‚’ã—ãŸæ™‚ã¯é€šå¸¸é€šã‚Šã®ã‚·ãƒ¼ãƒ³ã«æˆ»ã£ã¦ã»ã—ã„ã€ã¨ã„ã£ãŸã‚±ãƒ¼ã‚¹ã§ã™ã€‚

Navigathenaã§ã¯ã€`ISceneNavigator`ã®å±¥æ­´ã‚’ç›´æ¥æ“ä½œã™ã‚‹`ISceneHistoryBuilder`ã‚’`GetHistoryBuilderUnsafe`ã‚’ä½¿ç”¨ã—ã¦å–å¾—ã§ãã¾ã™ã€‚

```cs
using MackySoft.Navigathena.SceneManagement;
using MackySoft.Navigathena.SceneManagement.Unsafe; // IUnsafeSceneNavigatorã®æ©Ÿèƒ½ã®ä½¿ç”¨ã«å¿…è¦

//...

// ç¾åœ¨ã®å±¥æ­´ã‹ã‚‰ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ä»¥å¤–ã‚’å‰Šé™¤ã—ã€ä¸€ã¤å‰ã®ã‚·ãƒ¼ãƒ³ã¨ã—ã¦Homeã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ ã—ã€å±¥æ­´ã‚’å†æ§‹ç¯‰ã™ã‚‹ã€‚
GlobalSceneNavigator.Instance.GetHistoryBuilderUnsafe()
  .RemoveAllExceptCurrent()
  .Add(new SceneHistoryEntry(SceneDefinitions.Home, TransitionDefinitions.Loading, new SceneDataStore())))
  .Build();

// Popã™ã‚‹ã¨ã€Homeã‚·ãƒ¼ãƒ³ã«æˆ»ã‚‹
await GlobalSceneNavigator.Instance.Pop();
```

å–å¾—ã—ãŸ`ISceneHistoryBuilder`ã¯ã€`ISceneNavigator`ã®é·ç§»æ“ä½œãŒè¡Œã‚ã‚ŒãŸå¾Œã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³å·®ç•°ã«ã‚ˆã£ã¦ä½¿ç”¨ä¸å¯ã«ãªã‚Šã¾ã™ã€‚ãªã®ã§ã€é·ç§»æ“ä½œã‚’è¡Œã†å‰ã«`ISceneHistoryBuilder`ã§ã®å±¥æ­´æ“ä½œå‡¦ç†ã‚’å®Œäº†ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®æ©Ÿèƒ½ã¯`ISceneNavigator`ã«ã¯ä»˜å±ã—ã¦ãŠã‚‰ãšã€`IUnsafeSceneNavigator`ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚«ã‚¹ã‚¿ãƒ `ISceneNavigator`ã‚’å®Ÿè£…ã™ã‚‹éš›ã«ã‚·ãƒ¼ãƒ³å±¥æ­´æ“ä½œæ©Ÿèƒ½ãŒå¿…è¦ãªå ´åˆã¯ã€`IUnsafeSceneNavigator`ã‚’è¿½åŠ ã§å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚ï¼ˆ`GlobalSceneNavigator`ã¨`StandardSceneNavigator`ã¯ã€æ˜ç¤ºçš„ã«`IUnsafeSceneNavigator`ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ï¼‰

:::message
åå‰ã«ã‚‚ä»˜ã„ã¦ã„ã‚‹é€šã‚Šã€`IUnsafeSceneNavigator`ã¯Unsafeãªæ©Ÿèƒ½ãªã®ã§å¤šç”¨ã¯æ¨å¥¨ã—ã¦ã„ã¾ã›ã‚“ã€‚
:::

## Addressables Systemã¨ã®çµ±åˆ

Navigathenaã«ãŠã„ã¦ã€å„ã‚·ãƒ¼ãƒ³ã®ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰ã®ä½ãƒ¬ãƒ™ãƒ«å‡¦ç†ã¯`ISceneIdentifier`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§æ‰±ã‚ã‚Œã¾ã™ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`BuiltInSceneIdentifier`ã®ã¿å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ãŒã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«[ã€Addressablesã€](https://docs.unity3d.com/Packages/com.unity.addressables@2.0/manual/index.html)ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°`AddressalbeSceneIdentifier`ãŒä½¿ç”¨å¯èƒ½ã«ãªã‚Šã€Addressablesã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã„ã‚‹ã‚·ãƒ¼ãƒ³ã®ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«çµ„ã¿è¾¼ã‚€ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€å®Ÿéš›ã«ä½œã£ã¦ã„ã‚‹ã‚²ãƒ¼ãƒ ã§ã®ä½¿ç”¨ä¾‹ã§ã™ã€‚

```cs:SceneDefinitions.cs
using MackySoft.Navigathena.SceneManagement;
using MackySoft.Navigathena.SceneManagement.AddressableAssets;

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ã•ã‚Œã‚‹ã‚·ãƒ¼ãƒ³ã®å®šç¾©
public static class SceneDefinitions
{

  // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã§ã¯BuiltInSceneIdentifierã‚’ä½¿ç”¨ã™ã‚‹
  public static ISceneIdentifier Splash { get; } = new BuiltInSceneIdentifier("Splash");

  // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ä»¥é™ã®ã‚·ãƒ¼ãƒ³ã§ã¯ã€Addressablesã®ä¾å­˜æ€§ã‚’è§£æ±ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€AddressableSceneIdentifierã‚’ä½¿ç”¨ã™ã‚‹
  // å¼•æ•°ã«ã¯`object key`ã‚’æ¸¡ã™
  public static ISceneIdentifier Title { get; } = new AddressableSceneIdentifier("Title");
  public static ISceneIdentifier Introduction { get; } = new AddressableSceneIdentifier("Introduction");
  public static ISceneIdentifier Home { get; } = new AddressableSceneIdentifier("Home");
  public static ISceneIdentifier Game { get; } = new AddressableSceneIdentifier("Game");
}
```

`ISceneIdentifier`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã‚«ãƒ—ã‚»ãƒ«åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ä½¿ç”¨ã™ã‚‹ã‚·ãƒ¼ãƒ³ãŒãƒ“ãƒ«ãƒˆã‚¤ãƒ³ã‹Addressableã‹ã©ã†ã‹æ°—ã«ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
`ISceneIdentifier`ã®ä¸­èº«ã¯å˜ç´”ã§ã€`CreateHandle`ã§`ISceneHandle`ã‚’è¿”ã—ã€è¿”ã•ã‚ŒãŸ`ISceneHandle`ãŒå®Ÿéš›ã®ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚„ãƒªã‚½ãƒ¼ã‚¹ã®å‡¦ç†ã‚’æ‹…ã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã‚’åŸºã«æ‹¡å¼µã‚’è¡Œãˆã°ã€ç‹¬è‡ªã®ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†æ–¹å¼ã«ã‚‚å¯¾å¿œå¯èƒ½ã§ã™ã€‚

```cs
public interface ISceneIdentifier
{
  ISceneHandle CreateHandle ();
}

public interface ISceneHandle
{
  UniTask<Scene> Load (IProgress<float> progress = null, CancellationToken cancellationToken = default);
  UniTask Unload (IProgress<float> progress = null, CancellationToken cancellationToken = default);
}
```

`AddressableSceneIdentifier`ã®å ´åˆã¯ã€Addressablesã®`LoadSceneAsync`/`UnloadSceneAsync`ã‚’ãƒ©ãƒƒãƒ—ã—ã¦ã„ã‚‹ã®ã§ã€ã‚‚ã¡ã‚ã‚“ã‚¢ã‚»ãƒƒãƒˆã®ä¾å­˜é–¢ä¿‚ã‚‚è§£æ±ºã—ã¦ãã‚Œã¾ã™ã€‚

## ä¾å­˜æ€§æ³¨å…¥ã¨ã®çµ±åˆ

ã‚·ãƒ¼ãƒ³ç®¡ç†åŸºç›¤ã¯ã€Œèª°ãŒãã®ç”»é¢ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ±æ‹¬ã™ã‚‹ã®ã‹ã€ã¨ã„ã†ã€ã‚²ãƒ¼ãƒ é–‹ç™ºã®ä¸­ã§ã‚‚è¨­è¨ˆã®æ ¹å¹¹ã‚’å·¦å³ã™ã‚‹ä¸­æ¢ã«ãªã‚Šã‚„ã™ã„ã§ã™ã€‚ãã®ãŸã‚ã€ã‚·ãƒ¼ãƒ³ç®¡ç†åŸºç›¤ãŒä¾å­˜æ€§ã®æ³¨å…¥ï¼ˆDIï¼‰ã‚’çµ±åˆã—ã¦ãŠãã“ã¨ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ»è¨­è¨ˆã«ãŠã„ã¦é¸æŠè‚¢ã‚’å¢—ã‚„ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

Navigathenaã§ã¯ã€SceneEntryPoint ã®ä¸Šã«DIã‚³ãƒ³ãƒ†ãƒŠã¨ã®æ©Ÿèƒ½çµ±åˆã‚’çµ„ã¿è¾¼ã‚€ã“ã¨ã§ã€ä¾å­˜æ€§æ³¨å…¥ã«å¯¾å¿œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯[ã€VContainerã€](https://github.com/hadashiA/VContainer)ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ï¼‰

ã“ã®çµ±åˆã§ã¯ã€`SceneEntryPointBase`ï¼ˆ`ISceneEntryPoint`ï¼‰ã‚’ç¶™æ‰¿ã™ã‚‹ä»£ã‚ã‚Šã«ã€`SceneLifecycleBase`(`ISceneLifecycle`)ã‚’ç¶™æ‰¿ã—ãŸå‹ã‚’DIã‚³ãƒ³ãƒ†ãƒŠã«ç™»éŒ²ã—ã€Navigathenaã§å®šç¾©æ¸ˆã¿ã®`ScopedSceneEntryPoint`ã‚’ã‚·ãƒ¼ãƒ³ã«é…ç½®ã™ã‚‹ã“ã¨ã§ã€ã‚·ãƒ¼ãƒ³ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆ`MonoBehaviour`ï¼‰ã‹ã‚‰åˆ‡ã‚Šé›¢ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```cs:TitleLifetimeScope.cs
public override void Configure (IContainerBuilder builder)
{
  builder.RegisterSceneLifecycle<TitleSceneLifecycle>();
}
```

:::message
VContainerã®ã‚³ãƒ³ãƒ†ãƒŠãŒè¦ªã‚’æ±ºã‚ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ä»•æ§˜ä¸Šã€å°‘ã—ãƒãƒƒã‚­ãƒ¼ã§ã™ãŒ`LifetimeScope`ã®GameObjectã¯éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`ScopedSceneEntryPoint`ã®ã‚¤ãƒ³ã‚¹ãƒšã‚¯ã‚¿ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹`Create LifetimeScope`ãƒœã‚¿ãƒ³ã‹ã‚‰ç°¡å˜ã«ç”Ÿæˆãƒ»è¨­å®šãŒå‡ºæ¥ã¾ã™ã€‚
:::

ã“ã‚Œã«ã‚ˆã‚Šã€ä¾å­˜æ€§æ³¨å…¥ã«ã‚ˆã‚‹è«¸ã€…ã®ãƒ¡ãƒªãƒƒãƒˆã‚’äº«å—ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ãŒã€ã“ã®çµ±åˆã§ç‰¹ã«å¬‰ã—ã„ã®ã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰åˆ‡ã‚Šé›¢ã™ã“ã¨ã§å¾—ã‚‰ã‚Œã‚‹ [**ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€**](https://vcontainer.hadashikick.jp/ja/resolving/constructor-injection) ã§ã—ã‚‡ã†ã€‚

å¤§ããåˆ†ã‘ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªåˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

- ä¾å­˜æ€§ãŒè§£æ±ºã§ããªã„å ´åˆã«ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹ãŸã‚ã€ä¾å­˜æ€§ã®è§£æ±ºæ¼ã‚Œã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚å‚ç…§ãŒè¶³ã‚Šãªã„å ´åˆã¯ã€ã‚·ãƒ¼ãƒ³ã®åˆæœŸåŒ–æ™‚ã«ä¾‹å¤–ã§æ­¢ã¾ã‚‹ãŸã‚ã€é–‹ç™ºè€…ãŒã„ã¡æ—©ãæ°—ä»˜ãã“ã¨ãŒã§ãã¾ã™ã€‚
- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç”Ÿæˆæ™‚ã«ä¾å­˜æ€§ãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚Unityã§ã‚ã‚ŠãŒã¡ãªã€ŒåˆæœŸåŒ–é †åºã®é–¢ä¿‚ã§`NullReferenceException`ãŒç™ºç”Ÿã™ã‚‹ï¼ã€ã¨ã„ã†äº‹ã‚’æ°—ã«ã™ã‚‹å¿…è¦ãŒç„¡ããªã‚Šã¾ã™ã€‚
- ä¾å­˜æ€§ã‚’`readonly`ã«ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã‚ã‚‹ãŸã‚ã€ä¸å¤‰æ€§ã‚’ä¿è¨¼ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ãã‚Œã«ã‚ˆã‚Šã€ä¸æ­£ãªæ›¸æ›ãˆã«ã‚ˆã‚‹äºˆæœŸã›ã¬ä¸å…·åˆã‚’é˜²æ­¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- ä¾å­˜é–¢ä¿‚ãŒæ˜ç¤ºçš„ã«ãªã‚Šã€ãã®ã‚¯ãƒ©ã‚¹ãŒä½•ã«ä¾å­˜ã—ã¦ã„ã‚‹ã‹ãŒã²ã¨ç›®ã§æŠŠæ¡å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚è²¬ä»»éå¤šãªã‚¯ãƒ©ã‚¹ãŒåˆ†ã‹ã‚Šã‚„ã™ããªã‚Šã€ä¿å®ˆæ€§ä½ä¸‹ã®å…†å€™ã«æ°—ä»˜ãã‚„ã™ããªã‚Šã¾ã™ã€‚ï¼ˆåœ°ç„ã‚’è¦‹ãªãã¦æ¸ˆã‚€ï¼ï¼‰

ã“ã®ã‚ˆã†ã«ã€DIã¨ã®çµ±åˆã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå“è³ªã‚’ä¿ã¤ã†ãˆã§æœ‰åŠ¹ãªãƒ„ãƒ¼ãƒ«ã«ãªã‚Šã¾ã™ã€‚

ã¡ãªã¿ã«ã€Unityã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã„ã–DIã‚’å°å…¥ã—ã‚ˆã†ã¨ã—ãŸã‚‰ã€ŒDIåˆ†ã‹ã‚‰ãªã„ï½ã€ã«ãªã‚ŠãŒã¡ã§ã™ãŒã€ãã®åŸå› ã¯ **ã€Œã©ã“ã‚’èµ·ç‚¹ã«ä½œã£ã¦ã„ã‘ã°åˆ†ã‹ã‚‰ãªã„ã€** ã«é›†ç´„ã•ã‚Œã‚‹ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

VContainerã§ã‚‚ã€Presenterãªã©ã®èµ·ç‚¹ã‚’ä½œã‚‹ãŸã‚ã®[ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½](https://vcontainer.hadashikick.jp/ja/integrations/entrypoint)ãŒå­˜åœ¨ã—ã¾ã™ãŒã€ã€Œã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¯ä¸€ã¤ã¾ã§ã€ã¨ã„ã†ã‚ˆã†ãªåˆ¶ç´„ã¯ãªã„ãŸã‚ã€**ã€Œæ©Ÿèƒ½ã‚’ã©ã®æ§˜ã«é€£æºã•ã›ã€ã‚²ãƒ¼ãƒ ã¨ã—ã¦ã®ãƒ•ãƒ­ãƒ¼ã‚’æˆç«‹ã•ã›ã¦ã„ãã‹ã€** ã¨ã„ã†ã¨ã“ã‚ã§æ‚©ã‚€ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ãã®ç‚¹ã€ã€ŒNavigathena + DIã€ã§ã¯ã€ŒSceneLifecycleã¨ã„ã†å˜ä¸€ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã€ãŒåˆ†ã‹ã‚Šã‚„ã™ã„èµ·ç‚¹ã¨ãªã£ã¦ãã‚Œã¾ã™ã€‚å®Ÿéš›ã€SceneLifecycleã‚‚LifetimeScopeï¼ˆDIã‚³ãƒ³ãƒ†ãƒŠï¼‰ã‚‚ã€Œèµ·ç‚¹ã€ã¨ã„ã†å½¹å‰²ãŒåŒã˜ãªã®ã§ã€è‡ªç„¶ãªæµã‚ŒãŒä½œã‚Šã‚„ã™ãã€ç›¸æ€§ãŒè‰¯ã‹ã£ãŸã‚Šã—ã¾ã™ã€‚

ãã®ãŸã‚ã€**ã€ŒDIã®æ‰±ã„ã®åˆ†ã‹ã‚Šã‚„ã™ã•ã€** ã«ãŠã„ã¦ã€ã‹ãªã‚Šæ‰±ã„ã‚„ã™ããªã£ã¦ã„ã‚‹ã®ã§ãœã²ï¼ï¼ˆã“ã®çµ±åˆã‚’ä½¿ã£ã¦ã„ã¦ã‚‚ã€VContainerã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½è‡ªä½“ã¯ã‚¬ãƒ³ã‚¬ãƒ³ä½¿ã£ã¦ã„ãäº‹ã«ãªã‚‹ã¨æ€ã„ã¾ã™ãŒï¼‰

## FAQ

### è¤‡æ•°ã‚·ãƒ¼ãƒ³ï¼ˆã‚µãƒ–ã‚·ãƒ¼ãƒ³ï¼‰ã®ãƒ­ãƒ¼ãƒ‰ã¯ã©ã†ã™ã‚‹ã‹ï¼Ÿ

ä¾‹ãˆã°ã€ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã®ã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã—ãŸæ™‚ã€è¿½åŠ ã§ã‚¹ãƒ†ãƒ¼ã‚¸ã‚„UIã‚’å«ã‚“ã ã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã—ãŸã„ã‚±ãƒ¼ã‚¹ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã“ã†ã„ã†å®Ÿè£…ã‚’ã™ã‚‹ã¨ãã«æ™‚æŠ˜ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚·ãƒ¼ãƒ³ç®¡ç†ãƒ©ãƒƒãƒ‘ãƒ¼ã§ã‚µãƒ–ã‚·ãƒ¼ãƒ³ã®ç®¡ç†ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

```cs
// ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã®ç‚ºã®ã‚·ãƒ¼ãƒ³ç¾¤ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
MyMultiSceneManager.LoadSceneGroup("Ingame", "HUD", $"Stage_{stageId}");
```

Navigathenaã§ã¯ãã†ã„ã£ãŸã‚µãƒ–ã‚·ãƒ¼ãƒ³æ©Ÿèƒ½ã¯æ˜ç¤ºçš„ã«ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
ã“ã‚Œã¯ã€ **é·ç§»å…ˆã¨é·ç§»å…ƒã«ç›¸äº’ä¾å­˜æ€§ã‚’æŒãŸã›ãªã„ãŸã‚** ã§ã™ã€‚

é©åˆ‡ãªç®¡ç†ã¨ã—ã¦ã¯ã€Ingameã‚·ãƒ¼ãƒ³ãŒHUDã‚·ãƒ¼ãƒ³ã«å¯¾ã—ã¦ã®ä¾å­˜æ€§ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€Ingameã‚·ãƒ¼ãƒ³è‡ªèº«ãŒHUDã‚·ãƒ¼ãƒ³ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã—ã€ã“ã®ç®¡ç†ã‚’é·ç§»å…ƒå´ã§è¡Œã£ã¦ã—ã¾ã†ã¨ã€Ingameã‚·ãƒ¼ãƒ³ã¯æš—é»™çš„ã«é·ç§»å…ƒã‚·ãƒ¼ãƒ³ã«ä¾å­˜ã™ã‚‹ã“ã¨ã«ãªã‚Šã€é·ç§»å…ƒã¨é·ç§»å…ˆã¯ç›¸äº’ä¾å­˜æ€§ã‚’æŒã¤ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ãã—ã¦ã€**ç›¸äº’ä¾å­˜æ€§ã‚’æŒã¤ã¨ã€Œèª°ãŒã‚·ãƒ¼ãƒ³ã‚’ç®¡ç†ã—ã¦ã„ã‚‹ã‹ã€ã¨ã„ã†è²¬ä»»ãŒæ›–æ˜§ã«ãªã‚Šã€å¤‰æ›´å›°é›£ãªã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿã¿å‡ºã™ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã‚Šã¾ã™ã€‚**

ã“ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã¯ã€

**ã€Œã€ã‚·ãƒ¼ãƒ³é–“ã®ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ã€ã§ã‚¹ãƒ†ãƒ¼ã‚¸IDãªã©ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚„ã‚Šå–ã‚Šã—ã€é·ç§»å…ˆã‚·ãƒ¼ãƒ³ã®`SceneEntryPoint`ï¼ˆãŠã‚ˆã³`SceneLifecycle`ï¼‰ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«å†…ã§`UnityEngine.SceneManagement`ï¼ˆã¾ãŸã¯ãã‚Œã«é¡ã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰ã‚’ä½¿ã£ã¦ã€ã‚µãƒ–ã‚·ãƒ¼ãƒ³ã‚’ç®¡ç†ã™ã‚‹ã€**

ã“ã¨ã§è²¬ä»»ã‚’æ˜ç¢ºåŒ–ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã¯Ingameã‚·ãƒ¼ãƒ³ã®å®Ÿè£…ä¾‹ã§ã™ã€‚

```cs:IngameSceneEntryPoint.cs
long m_StageId;

protected override async UniTask OnInitialize (ISceneDataReader reader, IProgress<IProgressDataStore> progress, CancellationToken cancellationToken)
{
  // Ingameã‚·ãƒ¼ãƒ³ã§å¿…è¦ãªã‚µãƒ–ã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
  await SceneManager.LoadSceneAsync("HUD", LoadSceneMode.Additive).ToUniTask(cancellationToken: cancellationToken);

  // Ingameã‚·ãƒ¼ãƒ³ã«æ¸¡ã™ãŸã‚ã«å®šç¾©ã—ãŸãƒ‡ãƒ¼ã‚¿å‹ï¼ˆIngameSceneDataï¼‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹
  var data = reader.Read<IngameSceneData>();
  m_StageId = data.StageId;
  await SceneManager.LoadSceneAsync($"Stage_{data.StageId}", LoadSceneMode.Additive).ToUniTask(cancellationToken: cancellationToken);
}

protected override async UniTask OnFinalize (ISceneDataWriter writer, IProgress<IProgressDataStore> progress, CancellationToken cancellationToken)
{
  // Ingameã‚·ãƒ¼ãƒ³ã§ç®¡ç†ã—ã¦ã„ã‚‹ã‚µãƒ–ã‚·ãƒ¼ãƒ³ã‚’ç ´æ£„ã™ã‚‹
  await SceneManager.UnloadSceneAsync("HUD").ToUniTask(cancellationToken: cancellationToken);
  await SceneManager.UnloadSceneAsync($"Stage_{m_StageId}").ToUniTask(cancellationToken: cancellationToken);
}
```

```cs
await GlobalSceneNavigator.Instance.Push(SceneDefinitions.Ingame, sceneData: new IngameSceneData
{
  StageId = 1
});
```

é·ç§»å…ƒã¯ã€Œé·ç§»å…ˆã‚·ãƒ¼ãƒ³ã®æ§‹ç¯‰ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã€ã«è²¬å‹™ã‚’çµã‚Šã€é·ç§»å…ˆã¯ã‚µãƒ–ã‚·ãƒ¼ãƒ³ã®ç®¡ç†è²¬ä»»ã‚’æŒã¤ã“ã¨ã§ã€ã€Œã‚·ãƒ¼ãƒ³ãŒã©ã®ã‚µãƒ–ã‚·ãƒ¼ãƒ³ã‚’æŒã¡ã€ã©ã®ã‚ˆã†ã«ãã‚Œã‚’ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚·ãƒ¼ãƒ³å†…ã§å®Œçµã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

é·ç§»æ“ä½œã¯åŸå‰‡ã¨ã—ã¦ã€**ã€Œé·ç§»å…ƒã¯ã€é·ç§»å…ˆãŒæä¾›ã—ã¦ã„ã‚‹ã‚‚ã®ä»¥ä¸Šã‚’ä½¿ç”¨ã—ãªã„ã€** ã¨ã„ã†é‹ç”¨ãŒæœ›ã¾ã—ã„ã§ã™ã€‚

ã€Œé·ç§»å…ˆãŒæä¾›ã—ã¦ã„ã‚‹ã‚‚ã®ã€ã¨ã¯ã€ã€Œã‚·ãƒ¼ãƒ³ã®è­˜åˆ¥å­ï¼ˆã‚·ãƒ¼ãƒ³åãªã©ï¼‰ã€ã‚„ã€Œã‚·ãƒ¼ãƒ³ã«æ¸¡ã™ãŸã‚ã«äº‹å‰å®šç¾©ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿å‹ã€ã®äº‹ã§ã™ã€‚ä¾‹ãˆã°ã€Ingameã‚·ãƒ¼ãƒ³ã¯ã€Œ`Ingame`ã¨ã„ã†è­˜åˆ¥å­ã€ã¨ã€Œ`IngameSceneData`ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿å—ã‘æ¸¡ã—ç”¨ã®ãƒ‡ãƒ¼ã‚¿å‹ã€ã‚’æä¾›ã™ã‚‹ã“ã¨ã§Ingameã«å¯¾ã™ã‚‹é·ç§»æ“ä½œã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

ã“ã®åŸå‰‡ã‚’å®ˆã‚‹ã“ã¨ã§ã€ **ã€Œã‚·ãƒ¼ãƒ³ã‚’æ­£å¸¸ã«å‹•ã‹ã™ãŸã‚ã«å¿…è¦ãªãƒ­ã‚¸ãƒƒã‚¯ãŒæ§˜ã€…ãªå ´æ‰€ã«åˆ†æ•£ã—ã¦ã„ã¦ã€ã‚·ãƒ¼ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æŠŠæ¡ã§ããªã„ï¼ã€â†’ã€Œå¤‰æ›´ã‚’åŠ ãˆãŸã‚‰ã€å¤‰ãªã¨ã“ã‚ã§ä¸å…·åˆãŒå‡ºã‚‹ï¼ã€** ã¨ã„ã£ãŸå•é¡Œã‚’é˜²æ­¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¯¿å‘½ã‚’é€šã—ã¦ã€å¸¸ã«å­˜åœ¨ã™ã‚‹ã‚·ãƒ¼ãƒ³ã‚’æŒã¡ãŸã„

ã“ã‚Œã¯å€‹äººçš„ãªãƒ‹ãƒ¼ã‚ºã§ã‚‚ã‚ã‚‹ã®ã§ã™ãŒã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¯¿å‘½å†…ã§å¸¸ã«å­˜åœ¨ã—ç¶šã‘ã‚‹ã‚·ãƒ¼ãƒ³ï¼ˆ`Root`ã‚·ãƒ¼ãƒ³ã¨å‘¼ã‚“ã§ã„ã¾ã™ï¼‰ãŒã‚ã‚‹ã¨é–‹ç™ºä¸Šä¾¿åˆ©ã§ã™ã€‚å¯¿å‘½ãŒé•·ã„æ©Ÿèƒ½ã®ä¸€è¦§æ€§ãŒé«˜ã¾ã‚Šã¾ã™ã—ã€ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¢ã‚»ãƒƒãƒˆã®éƒ½åˆã§ã‚·ãƒ¼ãƒ³ä¸Šã«ä¿æŒã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹æ©Ÿèƒ½ã‚‚ã‚ã‚Šã¾ã™ã€‚`DontDestroyOnLoad`ã¨ã„ã†æ‰‹ã‚‚ã‚ã‚Šã¾ã™ãŒã€å–ã‚Šå›ã—ãŒåŠ¹ãã¥ã‚‰ã„ã®ãŒé›£ç‚¹ã§ã™ã€‚

é–‹ç™ºä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯`ScopedSceneEntryPoint`ã‚’æ‹¡å¼µã—ã¦ã€`EnsureParentScope`ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§`Root`ã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã„ã†æ‰‹æ³•ã‚’å–ã£ã¦ã„ã¾ã™ã€‚

```cs
public sealed class MyProjectScopedSceneEntryPoint : ScopedSceneEntryPoint
{

  const string kRootSceneName = "Root";

  protected override async UniTask<LifetimeScope> EnsureParentScope (CancellationToken cancellationToken)
  {
    // Load root scene.
    if (!SceneManager.GetSceneByName(kRootSceneName).isLoaded)
    {
      await SceneManager.LoadSceneAsync(kRootSceneName, LoadSceneMode.Additive)
        .ToUniTask(cancellationToken: cancellationToken);
    }

    Scene rootScene = SceneManager.GetSceneByName(kRootSceneName);

#if UNITY_EDITOR
    // Reorder root scene.
    EditorSceneManager.MoveSceneBefore(rootScene, gameObject.scene);
#endif

    // Build root LifetimeScope container.
    if (rootScene.TryGetComponentInScene(out LifetimeScope rootLifetimeScope, true) && rootLifetimeScope.Container == null)
    {
      await UniTask.RunOnThreadPool(() => rootLifetimeScope.Build(), cancellationToken: cancellationToken);
    }
    return rootLifetimeScope;
  }
}
```

## ãŠã‚ã‚Šã«

ã€Navigathenaã€ã¯ã€ŒNavigationã€ã«ã€çŸ¥ç•¥ã®ç¥æ§˜ã§ã‚ã‚‹ã€ŒAthenaã€ã‚’åˆã‚ã›ãŸé€ èªã§ã€ã€Œç”»é¢é·ç§»ã«çŸ¥ç•¥ã‚’ä¸ãˆã‚‹ã€ã¨ã„ã†ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’æŒã£ã¦ã„ã¾ã™ã€‚ç¥æ§˜ã®åå‰ã‚’å† ã™ã‚‹ã ã‘ã‚ã£ã¦ã€è¨­è¨ˆã«ã¯æ™‚é–“ã‚’è¦ã—ã¦ã„ã¾ã—ãŸã€‚

æ¥­å‹™ã‚„å€‹äººé–‹ç™ºã‚’å¹³è¡Œã—ãªãŒã‚‰ã€é¡ä¼¼äº‹ä¾‹ã‚’èª¿ã¹ãŸã‚Šã—ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¨­è¨ˆã‚’è€ƒãˆã¦ã„ã¾ã—ãŸãŒã€ã‚ˆã†ã‚„ãç´å¾—ã§ãã‚‹å½¢ã§ä¸€ã¤ã®ç­”ãˆã‚’å‡ºã›ãŸã‹ã¨æ€ã„ã¾ã™ã€‚
ã‚²ãƒ¼ãƒ é–‹ç™ºè€…ã¨ã—ã¦ã“ã‚Œã‹ã‚‰ã®é–‹ç™ºã§ã‚‚ä½¿ã£ã¦ã„ãã®ã§ã€ä½¿ã£ã¦ã„ã¦æ°—ã«ãªã£ãŸæ©Ÿèƒ½ã®æ”¹è‰¯ã‚’éšæ™‚åŠ ãˆã¦ã„ãæ‰€å­˜ã§ã™ã€‚

Navigathenaã¯MITãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ä¸‹ã§å…¬é–‹ã—ã¦ã‚ã‚Šã¾ã™ã€‚

https://github.com/mackysoft/Navigathena

GitHubã§â˜†ã‚’ä»˜ã‘ã¦ã„ãŸã ã‘ã‚‹ã¨ã€å¬‰ã—ããªã‚Šã¾ã™m(_ _)m

## å‚è€ƒ

- [ãƒŸãƒ©ãƒ†ã‚£ãƒ–ã§ã®ã‚¢ã‚¦ãƒˆã‚²ãƒ¼ãƒ è¨­è¨ˆã®ç´¹ä»‹](https://tech.mirrativ.stream/entry/2023/09/22/112042)
- [Webå‡ºèº«ã®Unityã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«ã‚ˆã‚‹å¤§è¦æ¨¡ã‚²ãƒ¼ãƒ ã®åŸºç›¤è¨­è¨ˆ](https://developers.cyberagent.co.jp/blog/archives/4262/)
- [ã€Unityã€‘æ–°è¦ã‚²ãƒ¼ãƒ ã®UIé–‹ç™ºã§æ°—ã‚’ã¤ã‘ãŸ39ã®Tipså‰ç·¨](https://qiita.com/ohbashunsuke/items/0570234362e2e45c0011)
- [Unityã§ã®è¤‡æ•°ã‚·ãƒ¼ãƒ³ã‚’ä½¿ã£ãŸã‚²ãƒ¼ãƒ ã®å®Ÿè£…æ–¹æ³•ã¨ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã«ã¤ã„ã¦](https://madnesslabo.net/utage/?page_id=11109)
- [Unityå°‚ç”¨æœ€é€ŸDIã‚³ãƒ³ãƒ†ãƒŠVContainer ã¨ã€Unityã«ãŠã‘ã‚‹DIã®å‹˜æ‰€](https://scrapbox.io/hadashiA/Unity%E5%B0%82%E7%94%A8%E6%9C%80%E9%80%9FDI%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8AVContainer_%E3%81%A8%E3%80%81Unity%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8BDI%E3%81%AE%E5%8B%98%E6%89%80)
